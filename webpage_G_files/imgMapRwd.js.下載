define(function(){
	
	function main(env, opt, file){

		var $set = {
				debug: false
			}

		$.extend($set, opt);

		var $window = $(window),
			$this = $(env),
			$map = $this.find('map');

		$map.each(function(i, d){
			var $this = $(d),
				$area = $this.find('area'),
				$img = $('[usemap="#'+ $this.attr('name') +'"]'),
				$img_na_w = $img.get(0).naturalWidth; // 圖片現在寬度

			if( $img.get(0).style.width.match('px') ) {
				$img_na_w = parseInt($img.get(0).style.width, 10);
			}
			
			if( $img.attr('width') ) {
				$img_na_w = parseInt($img.attr('width'), 10);
			}

			$window.on('resize', function(){
				setRwd($map);
			}).resize();

			
			//cp頁如果有頁籤的話，進行JS防呆處理

			if($('.page-content .classify').length > 0){

				$('.classify >.in >.ct >.in >ul').find('>li').click(function(e){
					if($img!=undefined){
						setRwd($map);
					}
				});
			}

			function setRwd() {
				var _size = $img.width() / $img_na_w;
	
				$area.each(function(i, d){
					var $this = $(d),
						$coords = $this.attr('data-coords');

					if( $coords === undefined ) {
						var _orange = $this.attr('coords');

						$this.attr('data-coords', _orange);
						$coords = _orange;
					}

					$coords = $coords.split(','); //轉為陣列

					var $coords_len = $coords.length;

					for( var _i = 0; _i < $coords_len; _i++ ) {
						$coords[_i] = parseInt($coords[_i], 10) * _size;
					}

					$this.attr('coords', $coords.toString());
				});
			}
		});


		//修改整合式CP頁標題標籤
		var $cpMenu = $('.cp-menu');

		if($cpMenu.length > 0){
			var $cpGroup = $cpMenu.nextAll();

			$cpGroup.each(function(){
				var $this = $(this),
					$group = $this.find('.group.default > .in > .hd > .in') 
					$headH3 = $group.find('.headH3'),
					$dataIndex = $headH3.attr('data-index'),
					$inner = $headH3.find('a').html();
	
				$headH3.replaceWith(function(){
					return '<h2 class="headH3" data-index="' + $dataIndex + '"><span>' + $inner + '</span></h2>' ;
				});
			});
		}
		// else{
		// 	$('.base-article .group.default > .in > .hd > .in > .headH3').each(function(){

		// 		var $_dataIndex = $(this).attr('data-index');
		// 		var $_inner = $(this).find('a').html();
			
		// 		$(this).replaceWith(function(){
		// 				return '<h2 class="headH3" data-index="' + $_dataIndex + '"><span>' + $_inner + '</span></h2>' ;
		// 			})
			
		// 	})
		// }

		if($set.debug) {
			console.log('預設值:', $set);
			console.log('檔案 '+ file +'.js 已順利執行。');
		}
	}
	
	return main;
});