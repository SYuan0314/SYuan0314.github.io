<!DOCTYPE html>
<html>

<head>
    <title>Website A</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h1 {
            color: #4CAF50;
        }

        h2 {
            color: #555;
        }

        p {
            margin-bottom: 10px;
        }

        a {
            color: #1E90FF;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .link-section {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
        }

        .highlight {
            font-weight: bold;
            color: red;
        }

        /* 修改后的統計欄樣式 */
        #statistics {
            width: 300px;
            height: 500px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            bottom: 150px;
            right: 20px;
            z-index: 1000;
            resize: both;
            overflow: auto;
            transition: height 0.3s ease;
        }

        #statistics h3 {
            text-align: center;
            color: #4CAF50;
            margin: 0;
            padding-bottom: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-item img {
            max-width: 50px;
            height: auto;
            margin-right: 10px;
        }

        .stat-item .item-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .stat-item .item-text {
            margin-right: 10px;
            color: #333;
        }

        .stat-item .item-time {
            color: #666;
            font-size: 12px;
            margin-left: auto;
        }

        .stat-item button {
            background-color: #FFA500;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: background-color 0.3s ease;
        }

        .stat-item button:hover {
            background-color: #FF8C00;
        }

        .stat-item .delete-button {
            background-color: #FF6347;
        }

        .stat-item .delete-button:hover {
            background-color: #FF4500;
        }

        #submit-button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }

        #submit-button:hover {
            background-color: #45a049;
        }

        .rating-text {
            color: red;
            /* 將 rating 的字體顏色設為紅色 */
        }

        .toggle-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
            transition: background-color 0.3s ease;
        }

        .toggle-button:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <h1>Webpage A</h1>
    <h2>Webpage A是用來熟悉本實驗＂鏈結文字與目標網頁相關性測試＂網頁操作方式</h2>
    <div class="link-section">
        <p>首先，當我們在待測網頁中發現連結：<a href="https://www.google.com" target="_blank">Google</a><br>
            我們就要點進去，判斷超鏈結文字與目標網頁的關聯性<br>
            本實驗中將關聯性分為: <span style="color: red;">非常相關</span>、<span style="color: red;">可能相關</span>、<span
                style="color: red;">不確定</span>、<span style="color: red;">可能不相關</span>、<span
                style="color: red;">非常不相關</span><br>
            以及 <span style="color: red;">Broken/Timeout</span>（ex：HTTP status code 404）<br>
        </p>
    </div>

    <div class="link-section">
        <p>By the way , 我們等等發現一個超連結就用<span style="color: red;">滑鼠選取它（左鍵拖曳反白）</span><br>
            便可以給予相似度評價，並將其加入至統計欄<br>
            此外統計欄內的相關性可以刪除～<br></p>
    </div>
    <div class="link-section">
        <p>下方是一個以文字為主的鏈結</p>
        <a href="https://mail.ntu.edu.tw/owa/calendar/231111d435d54d41908fa9c59d0812a3@ntu.edu.tw/4576890d12e040bab4ab864c413aa2be12994112486015644960/calendar.html"
            target="_blank">NTU 113學年度行事曆</a>
        <p>鏈結錨文字：NTU 113學年度行事曆</p>
        <p>目標網頁：NTU 113學年度行事曆</p>
        <p>當整個網頁的超連結都評分完後就可以點選送出<br>
            送出後會下載一個json檔，問卷填完後再麻煩<span style="color: red;">回傳該json檔</span></p>
    </div>

    <div class="link-section">
        <p>下方是一個以圖片為主的鏈結：</p>
        <a href="https://www.showtimes.com.tw/ticketing" target="_blank">
            <img src="src/image.jpg" alt="NTU 113學年度行事曆" style="max-width: 100%; height: auto;">
        </a>
        <p>鏈結圖片文字：NTU 113學年度行事曆 </p>
        <p>目標網頁：電影院購票網頁</p>
        <p>注１：有些元素可能不太好選取，煩請多多擔待: )</p>
        <p>注２：我們只關注在當前webpage與目標網頁之相關性<br>目標網頁與其更深層網頁關係並非本實驗所關注。</p>
    </div>

    <!-- 修改后的統計欄 -->
    <div id="statistics">
        <button class="toggle-button" onclick="toggleStatistics()">縮小</button>
        <h3>統計欄</h3>
        <div id="selected-items"></div>
        <button id="submit-button" onclick="submitStatistics()">送出</button>
    </div>

    <script>
        let isMinimized = false;

        function toggleStatistics() {
            const statistics = document.getElementById('statistics');
            const toggleButton = document.querySelector('.toggle-button');

            if (isMinimized) {
                statistics.style.height = '500px';
                toggleButton.textContent = '縮小';
                isMinimized = false;
            } else {
                statistics.style.height = '50px';
                toggleButton.textContent = '展開';
                isMinimized = true;
            }
        }

        let pageEnterTime = new Date().toLocaleString(); // 網頁進入時間

        document.addEventListener('DOMContentLoaded', function () {
            document.addEventListener('mouseup', function () {
                var selection = window.getSelection();
                var range = selection.getRangeAt(0);
                var rect = range.getBoundingClientRect();

                // 收集選取的內容
                var content = collectSelectedContent(range);

                if (content) {
                    showRatingOptions(rect, content, 'mixed');
                }
            });
        });

        function collectSelectedContent(range) {
            var content = {
                text: '',
                images: []
            };

            var fragment = range.cloneContents();
            var walker = document.createTreeWalker(fragment, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null, false);

            while (walker.nextNode()) {
                var node = walker.currentNode;

                if (node.nodeType === Node.TEXT_NODE) {
                    content.text += node.textContent.trim() + ' ';
                } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'IMG') {
                    content.images.push(node.src);
                }
            }

            content.text = content.text.trim();
            return content.text.length > 0 || content.images.length > 0 ? content : null;
        }

        function showRatingOptions(rect, content, type) {
            var ratingContainer = document.createElement('div');
            ratingContainer.classList.add('rating-container');

            var select = document.createElement('select');
            var defaultOption = document.createElement('option');
            defaultOption.textContent = '選擇相關性';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            var options = ['非常相關', '可能相關', '不確定', '可能不相關', '非常不相關', '連結毀損/回應逾時'];
            options.forEach(function (optionText) {
                var option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                select.appendChild(option);
            });

            ratingContainer.appendChild(select);
            document.body.appendChild(ratingContainer);

            // 確保位置正確並提高 z-index
            ratingContainer.style.position = 'absolute';
            ratingContainer.style.zIndex = '10000'; // 提高 z-index
            ratingContainer.style.left = (rect.left + window.scrollX) + 'px';
            ratingContainer.style.top = (rect.bottom + window.scrollY) + 'px';

            // 檢查並調整位置以確保在可見範圍內
            var containerRect = ratingContainer.getBoundingClientRect();
            if (containerRect.bottom > window.innerHeight) {
                ratingContainer.style.top = (rect.top + window.scrollY - containerRect.height) + 'px';
            }
            if (containerRect.right > window.innerWidth) {
                ratingContainer.style.left = (rect.right + window.scrollX - containerRect.width) + 'px';
            }

            select.addEventListener('mousedown', function () {
                isClickInside = true;
            });

            select.addEventListener('change', function () {
                var selectedRating = this.value;
                if (selectedRating) {
                    addToStatistics(content, selectedRating, type);
                    document.body.removeChild(ratingContainer);
                    console.log('Rating container removed.');
                    document.removeEventListener('click', handleClickOutside);
                }
            });

            let isClickInside = false;

            setTimeout(function () {
                document.addEventListener('click', handleClickOutside);
            }, 0);

            function handleClickOutside(event) {
                if (!ratingContainer.contains(event.target)) {
                    document.body.removeChild(ratingContainer);
                    console.log('Rating container removed due to outside click.');
                    document.removeEventListener('click', handleClickOutside);
                }
            }
        }

        function addToStatistics(content, rating, type) {
            var statistics = document.getElementById('selected-items');

            var item = document.createElement('div');
            item.classList.add('stat-item');
            var itemContent = document.createElement('div');
            itemContent.classList.add('item-content');

            var itemText = document.createElement('span');
            itemText.classList.add('item-text');

            if (type === 'mixed') {
                if (content.text.length > 0) {
                    itemText.innerHTML = content.text + ' - <span class="rating-text">相關性: ' + rating + '</span>';
                }

                if (content.images.length > 0) {
                    content.images.forEach(function (src) {
                        var img = document.createElement('img');
                        img.src = src;
                        img.alt = '已選擇的圖片';
                        itemText.appendChild(img);
                    });
                    itemText.innerHTML += ' - <span class="rating-text">相關性: ' + rating + '</span>';
                }
            } else if (type === 'image') {
                itemText.innerHTML = '<img src="' + content.src + '" alt="已選擇的圖片"> - <span class="rating-text">相關性: ' + rating + '</span>';
            } else {
                itemText.innerHTML = content.text + ' - <span class="rating-text">相關性: ' + rating + '</span>';
            }

            var itemTime = document.createElement('span');
            itemTime.classList.add('item-time');
            itemTime.textContent = '時間: ' + new Date().toLocaleString();

            var deleteButton = document.createElement('button');
            deleteButton.textContent = '刪除';
            deleteButton.classList.add('delete-button');
            deleteButton.addEventListener('click', function () {
                statistics.removeChild(item);
            });

            itemContent.appendChild(itemText);
            item.appendChild(itemContent);
            item.appendChild(itemTime); // 添加時間標記
            item.appendChild(deleteButton);

            statistics.appendChild(item);
        }

        function submitStatistics() {
            var statistics = document.getElementById('selected-items');
            var items = statistics.querySelectorAll('.stat-item');
            var data = [];

            items.forEach(function (item) {
                var textContent = item.querySelector('.item-text').textContent;
                var images = [];
                item.querySelectorAll('img').forEach(function (img) {
                    images.push(img.src);
                });
                var timeContent = item.querySelector('.item-time').textContent;
                data.push({
                    content: textContent,
                    images: images,
                    time: timeContent
                });
            });

            var submitTime = new Date().toLocaleString(); // 送出時間

            var jsonData = {
                pageEnterTime: pageEnterTime,
                submitTime: submitTime,
                data: data
            };

            var json = JSON.stringify(jsonData, null, 2);
            var blob = new Blob([json], { type: 'application/json' });
            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            a.href = url;
            a.download = 'Webpage_A.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // 跳轉到 /index.html
            window.location.href = './index.html';
        }
    </script>

</body>

</html>